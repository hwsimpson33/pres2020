---
title: "final-prediction"
author: "Helen Simpson"
date: "10/31/2020"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#ToDo: edit graphics, writeup and code comments, popular vote prediction
#county-level predictions for Pennsylvania, Nevada, Florida if time
#https://projects[.]fivethirtyeight.com/polls/president-general/national/

library(tidyverse)
library(broom)
library(readxl)
library(usmap)
library(dvmisc)
library(tableHTML)

polls.2020.raw <- read_csv("./president_polls.csv")
all.data <- read_csv("./all_data.csv")
```

```{r}
polls.2020 <- polls.2020.raw %>% 
  mutate(start_date = as.Date(start_date, tryFormats = c("%m/%d/%y"))) %>% 
  filter(fte_grade %in% c("A+", "A", "A-", "A/B", "B+", "B", "B-", "B/C"), 
         candidate_party %in% c("DEM", "REP"),
         !is.na(state)) %>% 
  select(poll_id, cycle, state, pollster, fte_grade, sample_size, population, start_date, end_date, candidate_party, pct) %>% 
  group_by(poll_id, candidate_party) %>% 
  mutate(poll.ave = sum(pct)/length(pct)) %>% 
  select(-pct) %>% 
  distinct() %>% 
  pivot_wider(names_from = candidate_party, values_from = poll.ave)

polls.030 <- polls.2020 %>% 
  filter(start_date > as.Date("2020-10-03")) %>% 
  group_by(state) %>% 
  arrange(state) %>% 
  mutate(rlead = REP - DEM,
         rlead.030 = sum(rlead / length(rlead))) %>% 
  select(state, rlead.030) %>% 
  distinct()

polls.30plus <- polls.2020 %>% 
  filter(start_date < as.Date("2020-10-03")) %>% 
  group_by(state) %>% 
  arrange(state) %>% 
  mutate(rlead = REP - DEM,
         rlead.30plus = sum(rlead / length(rlead))) %>% 
  select(state, rlead.30plus) %>% 
  distinct()

pollave.2020 <- merge(polls.030, polls.30plus, all = TRUE)

#actually there are state-wide polls...we'll just use those
# maine.data <- pollave.2020 %>% 
#   filter(state == "Maine CD-1" | state == "Maine CD-2") %>% 
#   mutate(rlead.030 = sum(rlead.030)/length(rlead.030),
#          rlead.30plus = sum(rlead.30plus)/length(rlead.30plus),
#          state = "Maine") %>% 
#   distinct()

nebraska.data <- pollave.2020 %>% 
  filter(state == "Nebraska CD-1" | state == "Nebraska CD-2") %>% 
  mutate(rlead.030 = rlead.030[2],
         rlead.30plus = sum(rlead.30plus)/length(rlead.30plus),
         state = "Nebraska") %>% 
  distinct()

# pollave.2020 <- merge(pollave.2020, maine.data, all = TRUE)
pollave.2020 <- merge(pollave.2020, nebraska.data, all = TRUE)

pollave.2020 <- pollave.2020 %>% filter(state != "Maine CD-1",
                                        state != "Maine CD-2",
                                        state != "Nebraska CD-1",
                                        state != "Nebraska CD-2")
```

```{r}
state.data <- all.data %>% 
  select(year, state, R_pv2p, D_pv2p, prev_Rvote, prev_Dvote, ave.30plus, ave.030) %>% 
  rename(rlead.030 = ave.030,
         rlead.30plus = ave.30plus) %>% 
  filter(!is.na(R_pv2p), 
         !is.na(prev_Rvote), 
         year >= 1972) %>% 
  mutate(rlead.prev = prev_Rvote - prev_Dvote,
         rlead.vote = R_pv2p - D_pv2p) %>% 
  select(-R_pv2p, -D_pv2p, -prev_Rvote, -prev_Dvote)

reg.data <- state.data %>%
  mutate(rlead.030 = case_when(is.na(rlead.030) ~ rlead.30plus,
                               !is.na(rlead.030) ~ rlead.030)) %>% 
  filter(state != "District of Columbia")

my.model.1 <- reg.data %>% 
  group_by(state) %>% 
  do(model = lm(rlead.vote ~ rlead.prev + rlead.030, .)) %>% 
  rowwise() %>% glance(model)

my.model.2 <- reg.data %>% 
  group_by(state) %>% 
  do(model = lm(rlead.vote ~ rlead.prev + rlead.030 + rlead.30plus, .)) %>% 
  rowwise() %>% glance(model)

my.model.3 <- reg.data %>% 
  group_by(state) %>% 
  do(model = lm(rlead.vote ~ rlead.prev + rlead.030 + as.factor(year), .)) %>% 
  rowwise() %>% glance(model)

```

```{r}
vote.2016 <- state.data %>% 
  filter(year == 2016) %>% 
  select(state, rlead.vote) %>% 
  rename(rlead.prev = rlead.vote)

data.2020 <- merge(pollave.2020, vote.2016, all = TRUE)

data.2020 <- data.2020 %>% 
  mutate(year = 2020, 
         rlead.vote = 0,
         rlead.vote = na_if(rlead.vote, 0))

state.data <- rbind(state.data, data.2020)
```

```{r}
reg.full.data <- state.data %>%
  mutate(rlead.030 = case_when(is.na(rlead.030) ~ rlead.30plus,
                               !is.na(rlead.030) ~ rlead.030)) %>% 
  group_by(state)

my.model.1 <- reg.full.data %>% 
  do(model = lm(rlead.vote ~ rlead.prev + rlead.030, .)) %>% 
  rowwise() %>% tidy(model) %>% 
  filter(state == "Alaska")

 
# my.predict <- tidy(predict(lm(rlead.vote ~ rlead.prev + rlead.030, data = reg.full.data), 
#         reg.full.data[reg.full.data$year == 2020,]))
#   
# test.data <- reg.full.data[reg.full.data$year == 2020,]
# 
# test.predict <- predict(my.model.1, state.data[year == 2020])
# pred_econ_inc <- predict(mod_econ_inc_, dat_econ_inc[dat_econ_inc$year == year,])
```

```{r}
split.data <- split(reg.full.data, reg.full.data$state)
```

```{r warning=FALSE}

my.names <- names(split.data)
states.model <- data.frame(0)
loop <- 0

for(df in split.data) {
  my.state <- paste(my.names[loop + 1])
  
  my.model <- lm(rlead.vote ~ rlead.prev + rlead.030, data = df)
  my.state.model <- tidy(my.model) %>% mutate(state = my.state)
  my.model.stats <- glance(my.model) %>% mutate(state = my.state)
  
  my.state.model <- merge(my.state.model, my.model.stats, all = TRUE)
  
  my.2020 <- df %>% filter(year == 2020)
  state.predict <- tidy(predict(my.model, my.2020, interval = "confidence"))
  my.state.model$my.predict <- state.predict$fit
  my.state.model$lwr <- state.predict$lwr
  my.state.model$upr <- state.predict$upr
  my.state.model$mse <- get_mse(my.model)
  
  my.prev <- df %>% filter(year == 2020)
  my.prev <- my.prev$rlead.prev
  
  my.state.model <- my.state.model %>% 
    mutate(my.predict = case_when(is.na(my.predict) ~ my.prev,
                                  !is.na(my.predict) ~ my.predict))

  
  states.model <- merge(states.model, my.state.model, all = TRUE)
  
# run out of sample fit to see how often states are called correctly
# year_list <- seq(from = 1972, to = 2016, by = 4)
# 
# year <- 1972
# outsamp_dflist <- lapply(year_list, function(year){
#   #true vote shares
#   oos.true <- df$rlead.vote[df$year == year]
# 
#   if (length(oos.true) > 0){
#     
#     #dataframes excluding the row (incumbency is backwards as everything is negated)
#     oos.df <- df %>% filter(!(year == year))
# 
#     #prediction dataframes
#     oos.p <- df %>% filter(year == year)
# 
#     #fundamental model out-of-sample prediction
#     oos.model <- lm(rlead.vote ~ rlead.prev + rlead.030, data = df )
#     oos.pred <- predict(oos.model, oos.p)
# 
#     c(year, 
#       margin_error = oos.pred - oos.true, 
#       winner_correct = ((oos.pred > 0) == (oos.true > 0))
#     )
#   }
# })
# 
#   outsamp_df <- do.call(rbind, outsamp_dflist)
# # colMeans(abs(outsamp_df[2:4]), na.rm=T) #
# # colMeans(outsamp_df[5:7], na.rm=T) ### classification accuracy
# 
# outsamp_df[,c("year","econ_winner_correct","poll_winner_correct","plus_winner_correct")] #
# 
# outsamp_dflist <- sapply(year_list, function(year){sapply(state_list, function(state) check_out(year,state))})
# 
# outsamp_df <- cbind("year", "state","fund_margin_error",
#                 "polls_margin_error","plus_margin_error","fund_correct","polls_correct","plus_correct")

  loop <- loop + 1
}

states.model <- states.model %>% 
  select(-X0) %>% 
  arrange(state, term)
```

```{r warning=FALSE}

my.names <- names(split.data)
states.model.2 <- data.frame(0)
loop <- 0

for(df in split.data) {
  my.state <- paste(my.names[loop + 1])
  
  my.model <- lm(rlead.vote ~ rlead.030, data = df)
  my.state.model <- tidy(my.model) %>% mutate(state = my.state)
  my.model.stats <- glance(my.model) %>% mutate(state = my.state)
  
  my.state.model <- merge(my.state.model, my.model.stats, all = TRUE)
  
  my.2020 <- df %>% filter(year == 2020)
  state.predict <- tidy(predict(my.model, my.2020, interval = "confidence"))
  my.state.model$my.predict <- state.predict$fit
  my.state.model$lwr <- state.predict$lwr
  my.state.model$upr <- state.predict$upr
  my.state.model$mse <- get_mse(my.model)
  
  
  my.prev <- df %>% filter(year == 2020)
  my.prev <- my.prev$rlead.prev
  
  my.state.model <- my.state.model %>% 
    mutate(my.predict = case_when(is.na(my.predict) ~ my.prev,
                                  !is.na(my.predict) ~ my.predict))

  
  states.model.2 <- merge(states.model.2, my.state.model, all = TRUE)
  loop <- loop + 1
}

states.model.2 <- states.model.2 %>% 
  select(-X0) %>% 
  arrange(state, term)
```

```{r}
predict.table.df <- states.model %>% 
  select(state, my.predict, lwr, upr) %>%
  distinct() %>% 
  rename(State = state, `Point prediction` = my.predict, `Lower bound` = lwr, `Upper bound` = upr)

predict.table <- tableHTML(predict.table.df, rownames = FALSE, border = 2, round = 4)

# print(predict.table, viewer = FALSE)

coefficients.table.df <- states.model %>%
  select(state, term, estimate, std.error, p.value) %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept", 
                             term == "rlead.030" ~ "Republican lead in last 30 days",
                             term == "rlead.prev" ~ "Republican win/loss margin in previous election")) %>% 
  filter(!is.na(term)) %>% 
  rename(State = state, Term = term, Estimate = estimate, `Std. error` = std.error, `p value` = p.value)

coefficients.table <- tableHTML(coefficients.table.df, rownames = FALSE, border = 2, round = 4)

# print(coefficients.table, viewer = FALSE)

fit.table.df <- states.model %>% 
  select(state, r.squared, adj.r.squared, mse) %>%
  filter(!is.na(r.squared)) %>% 
  rename(State = state, `r squared` = r.squared, `Adjusted r squared` = adj.r.squared, `Mean squared error` = mse)

fit.table <- tableHTML(fit.table.df, rownames = FALSE, border = 2, round = 4)

# print(fit.table, viewer = FALSE)
```

```{r}
predict.results <- states.model %>% 
  select(state, my.predict, lwr, upr) %>% 
  distinct() %>% 
  mutate(interval.size = upr - lwr)

predict.results.2 <- states.model.2 %>% 
  select(state, my.predict, lwr, upr) %>% 
  distinct() %>% 
  mutate(interval.size = upr - lwr) %>% 
  rename(my.predict.2 = my.predict, lwr.2 = lwr, upr.2 = upr, interval.size.2 = interval.size)

my.test <- merge(predict.results, predict.results.2)
my.test <- my.test %>% mutate(predict.diff = my.predict - my.predict.2,
                              interval.diff = interval.size - interval.size.2)

my.test %>% ggplot(aes(x = predict.diff, y = interval.diff)) + geom_point() + theme_classic()
hist(my.test$predict.diff)
hist(my.test$interval.diff)
```

```{r}
college <- read_excel("./electoralcollege.xlsx", skip = 1) %>% rename(state = State)

predict.results <- merge(predict.results, college, by = "state", all = TRUE)

predict.results <- predict.results %>% mutate(won = case_when(my.predict > 0 ~ 1,
                                                              my.predict < 0 ~ 0),
                                              total.votes = sum(won * ec.votes)) 

my.predict.results <- predict.results %>% 
  mutate(won.lwr = case_when(lwr > 0 ~ 1,
                             lwr < 0 ~ 0),
         won.lwr = case_when(!is.na(won.lwr) ~ won.lwr,
                             is.na(won.lwr) ~ won),
         total.votes.lwr = sum(won.lwr * ec.votes),
         won.upr = case_when(upr > 0 ~ 1,
                             upr < 0 ~ 0),
         won.upr = case_when(!is.na(won.upr) ~ won.upr,
                             is.na(won.upr) ~ won), 
         total.votes.upr = sum(won.upr * ec.votes))

predict.results <- merge(predict.results, my.predict.results, all = TRUE)

```

```{r}

plot.data <- predict.results %>% 
  mutate(margin = case_when((upr > 0 & lwr < 0) ~ abs(my.predict) / interval.size,
                            is.na(upr) ~ won,
                            (upr < 0 | lwr > 0) ~ won),
         all.margin = abs(my.predict) / interval.size, 
         new.won = case_when(won == 1 ~ won,
                             won == 0 ~ -1),
         margin.by.won = all.margin * new.won) %>% 
  select(state, my.predict, won, margin, all.margin, margin.by.won)

states_map <- usmap::us_map()

#copied from code for section1
won.map.plot <- plot_usmap(data = plot.data, regions = "state", values = "won") +
  scale_fill_gradient2(high = "red", 
                       mid = "blue",
                       limits = c(0, 1),
                       breaks = c(0, 1),
                       name = "Won") +
  theme_void() +
  labs(title = "Predicted victory by state", 
       subtitle  = "Biden is predicted to win blue states, Trump is predicted to win red states")
won.map.plot

ggsave("docs/images/won_map_plot.png", plot = won.map.plot, height = 5, width = 7.5)

margin.map.plot <- plot_usmap(data = plot.data, regions = "state", values = "margin") +
  scale_fill_gradient2(high = "red", 
                       mid = "blue",
                       name = "Margin") +
  theme_void() +
  labs(title = "title", 
       subtitle  = "subtitle")
margin.map.plot

uncertainty.map.plot <- plot_usmap(data = plot.data, regions = "state", values = "margin.by.won") +
  scale_fill_gradient2(high = "red", 
                       mid = "purple",
                       low = "blue",
                       name = "Distance") +
  theme_void() +
  labs(title = "Projected distance from 50% (normalized) by state", 
       subtitle = "Gray states do not have 2020 polls")
uncertainty.map.plot
ggsave("docs/images/uncertainty_map_plot.png", plot = uncertainty.map.plot, height = 5, width = 7.5)

```