---
title: "accuracy"
author: "Helen Simpson"
date: "11/17/2020"
output: html_document
---

```{r setup, include=FALSE}

rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tableHTML)
library(kableExtra)
```

```{r}

predict.raw <- read_csv("./predict_table.csv") %>% rename(state = State)
results.raw <- read_csv("./popvote_bystate_1948-2020.csv") %>% filter(year == 2020)

my.data <- merge(predict.raw, results.raw, all = TRUE) %>% 
  select(-total, 
         -D, -R, 
         -year) %>% 
  mutate(results.margin = (R_pv2p - D_pv2p) * 100,
         diff = `Point prediction` - results.margin, 
         my.sd = abs(`Upper bound` - `Point prediction`)/ 1.96,
         my.interval = abs(`Point prediction`/ my.sd),
         prob = pnorm(0, mean = `Point prediction`, sd = my.sd))

summary(my.data$diff)

test.data <- my.data %>% filter(diff > 10 | diff < -10)

hist(my.data$diff)

my.plot <- my.data %>% ggplot(aes(x = diff)) + geom_histogram(bins = 6) + theme_classic()
my.plot
```

```{r}
my.table.data <- my.data %>% 
  rename(`Point prediction (Republican margin)` = `Point prediction`,
         `Result (Republican margin)` = results.margin,
         Difference = diff, 
         State = state) %>% 
  select(-R_pv2p, -D_pv2p) %>% 
  filter(!is.na(Difference))
  
worst.results.data <- my.table.data %>% filter(Difference > 10 | Difference < -10)

kable(my.table.data) %>% 
  kable_styling(bootstrap_options = c("striped", "bordered")) %>% 
  kable_paper(full_width = FALSE) %>% 
  save_kable("./docs/images/results_table.png")

worst.results.table <- tableHTML(worst.results.data, rownames = FALSE, border = 2, round = 4, caption = "States I missed by more than 10%")

print(worst.results.table, viewer = FALSE)
  
```

```{r}
plot.0 <- my.data %>% ggplot(aes(x = `Point prediction`, y = results.margin)) + geom_point() + geom_abline(slope = 1) + theme_classic()
plot.0
plot.1 <- my.data %>% ggplot(aes(x = prob, y = results.margin)) + geom_point() + theme_classic()
plot.1

#ToDo: plot against actual victory margin, # of polls

```
