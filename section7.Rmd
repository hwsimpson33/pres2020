---
title: "section7"
author: "Helen Simpson"
date: "10/20/2020"
output: html_document
---

```{r setup, include=FALSE}

rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(broom)
library(lme4)
```

```{r}
my.data <- read_csv("./all_data.csv")

my.rplot <- my.data %>% ggplot(aes(x = turnout_pct, y = R_pv2p)) + geom_point() + geom_smooth(method = "lm") + theme_classic()
my.dplot <- my.data %>% ggplot(aes(x = turnout_pct, y = D_pv2p)) + geom_point() + geom_smooth(method = "lm") + theme_classic()
my.dplot

rmodel <- my.data %>% filter(!is.na(turnout_pct)) %>%
  group_by(state) %>% 
  do(tidy(lm(R_pv2p ~ turnout_pct, data = .))) %>% 
  filter(term == "turnout_pct")

dmodel <- my.data %>% filter(!is.na(turnout_pct)) %>%
  group_by(state) %>% 
  do(tidy(lm(D_pv2p ~ turnout_pct, data = .))) %>% 
  filter(term == "turnout_pct")

#r has 18 significant, d has 9 significant
rtest.data <- rmodel %>% filter(p.value < 0.1)
dtest.data <- dmodel %>% filter(p.value < 0.1)

hist(rmodel$estimate)
hist(dmodel$estimate)

state.rturnout.plot <- my.data %>%
  group_by(state) %>% 
  ggplot(aes(x = turnout_pct, y = R_pv2p)) + 
    geom_point() + 
    geom_smooth(method = "lm") + 
    facet_wrap(. ~ state) + 
    theme_classic()
state.rturnout.plot
ggsave("docs/images/state_turnout_plot.png", plot = state.rturnout.plot, height = 15, width = 22.5)

my.data <- my.data %>% group_by(state) %>% arrange(state, year) %>% mutate(prev_turnout = dplyr::lag(turnout_pct))

my.data$cut.turnout <- cut(my.data$turnout_pct, c(seq(from = 35, to = 80, by = 5)))

my.model <- lmer(R_pv2p ~ prev_Rvote + (1 + unem.diff|cut.turnout), data = my.data)
summary(my.model)
```