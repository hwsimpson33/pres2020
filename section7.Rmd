---
title: "section7"
author: "Helen Simpson"
date: "10/20/2020"
output: html_document
---

```{r setup, include=FALSE}

rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(broom)
library(lme4)
library(stringr)
library(readxl)
```

```{r}
state.turnout <- read_csv("./all_data.csv")

my.rplot <- state.turnout %>% ggplot(aes(x = turnout_pct, y = R_pv2p)) + geom_point() + geom_smooth(method = "lm") + theme_classic()
my.dplot <- state.turnout %>% ggplot(aes(x = turnout_pct, y = D_pv2p)) + geom_point() + geom_smooth(method = "lm") + theme_classic()
my.dplot

rmodel <- state.turnout %>% filter(!is.na(turnout_pct)) %>%
  group_by(state) %>% 
  do(tidy(lm(R_pv2p ~ turnout_pct, data = .))) %>% 
  filter(term == "turnout_pct")

dmodel <- state.turnout %>% filter(!is.na(turnout_pct)) %>%
  group_by(state) %>% 
  do(tidy(lm(D_pv2p ~ turnout_pct, data = .))) %>% 
  filter(term == "turnout_pct")

#r has 18 significant, d has 9 significant
rtest.data <- rmodel %>% filter(p.value < 0.1)
dtest.data <- dmodel %>% filter(p.value < 0.1)

hist(rmodel$estimate)
hist(dmodel$estimate)

state.rturnout.plot <- state.turnout %>%
  group_by(state) %>% 
  ggplot(aes(x = turnout_pct, y = R_pv2p)) + 
    geom_point() + 
    geom_smooth(method = "lm") + 
    facet_wrap(. ~ state) + 
    theme_classic()
state.rturnout.plot
ggsave("docs/images/state_turnout_plot.png", plot = state.rturnout.plot, height = 15, width = 22.5)

state.turnout <- state.turnout %>% group_by(state) %>% arrange(state, year) %>% mutate(prev_turnout = dplyr::lag(turnout_pct))

# my.data$cut.turnout <- cut(my.data$turnout_pct, c(seq(from = 35, to = 80, by = 5)))
# 
# my.model <- lmer(R_pv2p ~ prev_Rvote + (1 + unem.diff|cut.turnout), data = my.data)
# summary(my.model)
```

```{r}
#source: https://dataverse.harvard[.]edu/dataset.xhtml?persistentId=doi:10.7910/DVN/WRSW25
county.92.data.raw <- read_excel("./Turnout_Data_1992.xlsx", sheet = 3)
county.92.data <-  county.92.data.raw %>% 
  filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Pop`, 
         `Total Registered`, 
         Turnout, 
         Democrat...17, 
         Republican...18, 
         `Independent/Unenrolled...19`, 
         FIPS) %>% 
  dplyr::rename(dem.reg = Democrat...17, 
         rep.reg = Republican...18,
         ind.reg = `Independent/Unenrolled...19`) %>% 
  mutate(year = 1992)

county.96.data.raw <- read_excel("./Turnout_Data_1996.xlsx", sheet = 3)
county.96.data <- county.96.data.raw %>% 
  filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Pop`, 
         `Total Registered`, 
         Turnout, 
         Democrat...17, 
         Republican...18, 
         `Independent/Unaffiliated...19`, 
         FIPS) %>% 
  dplyr::rename(dem.reg = Democrat...17, 
         rep.reg = Republican...18,
         ind.reg = `Independent/Unaffiliated...19`) %>% 
  mutate(year = 1996)

county.turnout <- rbind(county.92.data, county.96.data)

county.00.data.raw <- read_excel("./Turnout_Data_2000.xlsx", sheet = 3)
county.00.data <- county.00.data.raw %>% filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Population`, 
         `Total Registered`, 
         Turnout, 
         Democrat...19, 
         Republican...20, 
         `Independent/Unenrolled...21`, 
         FIPS) %>% 
  dplyr::rename(`Voting Age Pop` = `Voting Age Population`,
         dem.reg = Democrat...19, 
         rep.reg = Republican...20,
         ind.reg = `Independent/Unenrolled...21`) %>% 
  mutate(year = 2000)

county.turnout <- rbind(county.turnout, county.00.data)

county.04.data.raw <- read_excel("./Turnout_Data_2004.xlsx", sheet = 3)
county.04.data <- county.04.data.raw %>% filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Pop`, 
         `Total Registered`, 
         Turnout, 
         Democrat...18, 
         Republican...19, 
         `Independent/Unenrolled...20`, 
         FIPS) %>% 
  dplyr::rename(dem.reg = Democrat...18, 
         rep.reg = Republican...19,
         ind.reg = `Independent/Unenrolled...20`) %>% 
  mutate(year = 2004)

county.turnout <- rbind(county.turnout, county.04.data)

county.08.data.raw <- read_excel("./Turnout_Data_2008.xlsx", sheet = 3)
county.08.data <- county.08.data.raw %>% filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Pop`, 
         `Total Registered`, 
         Turnout, 
         Democrat...19, 
         Republican...20, 
         `Independent/Unenrolled...21`, 
         FIPS) %>% 
  dplyr::rename(dem.reg = Democrat...19, 
         rep.reg = Republican...20,
         ind.reg = `Independent/Unenrolled...21`) %>% 
  mutate(year = 2008)

county.turnout <- rbind(county.turnout, county.08.data)

county.12.data.raw <- read_excel("./Turnout_Data_2012.xlsx", sheet = 3)
county.12.data <- county.12.data.raw %>% 
  dplyr::rename(...1 = `<- expand at left`,
         `Total Population` = Population,
         `Total Registered` = `Total Reg`,
         Turnout = `Total Vote`,
         dem.reg = Democratic...19, 
         rep.reg = Republican...20,
         ind.reg = `Independent...21`) %>% 
  filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Pop`, 
         `Total Registered`, 
         Turnout, 
         dem.reg, 
         rep.reg, 
         ind.reg, 
         FIPS) %>% 
  mutate(year = 2012)

county.turnout <- rbind(county.turnout, county.12.data)

county.16.data.raw <- read_excel("./Turnout_Data_2016.xlsx", sheet = 3)
county.16.data <- county.16.data.raw %>% 
  dplyr::rename(`Total Population` = Population,
                `Total Registered` = `Total Reg`,
                dem.reg = Democratic...19, 
                rep.reg = Republican...20,
                ind.reg = `Independent...21`) %>% 
  filter(!is.na(...1), ...2 != "T") %>% 
  select(...1, 
         ...2, 
         `Total Population`, 
         `Voting Age Pop`, 
         `Total Registered`, 
         Turnout, 
         dem.reg, 
         rep.reg, 
         ind.reg, 
         FIPS) %>% 
  mutate(year = 2016)

county.turnout <- rbind(county.turnout, county.16.data)

county.turnout <- county.turnout %>% dplyr::rename(county = ...1,
                                                   state_abb = ...2)
```

```{r}
#merge w/ county-level vote share + demo (2000, 2004, 2008, 2012, 2016)
#run regressions, vote share on turnout

county.demo <- read_csv("./demog_county_1990-2018.csv")
county.vote <- read_csv("./popvote_bycounty_2000-2016.csv")

#there are some that aren't being matched up/ don't exist in one dataset or the other, but I don't have time to track down why
county.data <- merge(county.turnout, county.vote, by = c("state_abb", "county", "year"), all = TRUE) %>% 
  filter(year > 1999) %>% 
  mutate(new.fips = as.character(fips),                                                                            end.fips = str_sub(new.fips, str_length(new.fips) - 2, str_length(new.fips)))

county.demo <- county.demo %>% dplyr::rename(state_abb = state, end.fips = fips_county) %>% filter(year %in% c(2000, 2004, 2008, 2012, 2016))

#merge isn't perfect, but good enough
county.level <- merge(county.data, county.demo, by = c("state_abb", "end.fips", "year"), all = TRUE) %>% filter(!is.na(end.fips), !is.na(state_abb))

county.level <- county.level %>% group_by(state_abb, end.fips) %>% arrange(state_abb, end.fips, year) %>% 
  mutate(turnout.pct = Turnout * 100 / `Total Registered`,
                                        lag.dmargin = dplyr::lag(D_win_margin))
```

```{r}
#ND has 0 voter registration
county.filter <- county.level %>%
  filter(!is.na(D_win_margin), !is.na(turnout.pct), state_abb != "ND", turnout.pct < 101) 

no.dem.model <- county.filter %>%
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct, .)) %>% 
  rowwise() %>% glance(model)

dem.model <- county.filter %>%
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct + year + lag.dmargin + White + age65, .)) %>% 
  rowwise() %>% tidy(model)

state.turnout.vote.plot <- county.filter %>% 
  group_by(state) %>% 
  ggplot(aes(x = turnout.pct, y = D_win_margin)) + 
    geom_point() + 
    geom_smooth(method = "lm") + 
    facet_wrap(. ~ state) + 
    theme_classic() + 
    labs(x = "x", 
         y = "y",
         title = "title")
                                                                  
ggsave("docs/images/state_turnout_vote_plot.png", plot = state.turnout.vote.plot, height = 15, width = 22.5)

#alternate approach
# my.model <- lmList(D_win_margin ~ turnout.pct + year + lag.dmargin + White | state, data = county.filter)
# summary.lm(my.model[2])
```

```{r}
state.county.data <- merge(state.turnout, county.filter, by = c("state", "year"), all = TRUE) %>% filter(year > 1999, !is.na(turnout.pct))

#still 23 sig
ec.model <- state.county.data %>%
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct + year + lag.dmargin + White + age65 + unem.diff, .)) %>% 
  rowwise() %>% glance(model)

polls.model <- state.county.data %>%
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct + year + lag.dmargin + White + age65 + unem.diff + ave.030, .)) %>% 
  rowwise() %>% tidy(model)

#still 22 sig
test.data <- polls.model %>% filter(term == "turnout.pct", p.value < 0.05)
```

```{r}
ads.raw <- read_csv("./ad_campaigns_2000-2012.csv")
offices.raw <- read_csv("./fieldoffice_2012_bycounty.csv")

#not 2016
state.ads <- ads.raw %>% arrange(cycle, party, state) %>% 
  group_by(cycle, party, state) %>% 
  mutate(state.total = sum(total_cost)) %>% 
  select(party, state, cycle, state.total) %>% 
  distinct() %>% 
  pivot_wider(names_from = party, values_from = state.total) %>% 
  mutate(democrat = case_when(is.na(democrat) ~ 0, #N/A means they didn't spend money that day, set to 0
                              !is.na(democrat) ~ democrat),
         ads.diff = (democrat - republican) / (democrat + republican)) %>% 
  select(-democrat, - republican) %>% 
  dplyr::rename(year = cycle,
                state_abb = state)

ads.state.county <- merge(state.county.data, state.ads, by = c("year", "state_abb"), all = TRUE) %>% 
  filter(!is.na(D_win_margin)) %>% 
  mutate(ads.diff = case_when(is.na(ads.diff) ~ 0, #N/A means they didn't spend money that day, set to 0
                              !is.na(ads.diff) ~ ads.diff))

#17 states
ads.model <- ads.state.county %>% filter(year != 2016) %>% mutate(ave.030 = case_when(is.na(ave.030) ~ ave.30plus, !is.na(ave.030) ~ ave.030)) %>% 
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct + year + lag.dmargin + White + age65 + unem.diff + ave.030 + ads.diff, .)) %>% 
  rowwise() %>% glance(model)


state.county.2012 <- state.county.data %>% filter(year == 2012)

state.county.offices <- merge(state.county.2012, offices.raw, by = c("fips"), all = TRUE) %>% filter(!is.na(turnout.pct))

ads.state.county.2012 <- ads.state.county %>% filter(year == 2012) %>% select(fips, ads.diff)

state.county.offices.ads <- merge(state.county.offices, ads.state.county.2012, by = "fips", all = TRUE)

state.county.offices <- state.county.offices.ads %>% mutate(offices.diff = obama12fo - romney12fo)

#13 significant
state.county.offices.filter <- state.county.offices %>% 
  filter(year == 2012) %>% 
  mutate(offices.diff = case_when(is.na(offices.diff) ~ 0, 
                                  !is.na(offices.diff) ~ offices.diff), 
         ave.030 = case_when(is.na(ave.030) ~ ave.30plus, 
                             !is.na(ave.030) ~ ave.030))
  
#13 sig w/o ave.030, 13 sig w/ ave.030 + filter on ave.030 n/as
offices.model <- state.county.offices.filter %>% filter(!is.na(ave.030)) %>% 
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct + lag.dmargin + White + age65 + offices.diff, .)) %>% 
  rowwise() %>% tidy(model)

offices.ads.model <- state.county.offices.filter %>% filter(!is.na(ave.030)) %>% 
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ turnout.pct + lag.dmargin + White + age65 + offices.diff, .)) %>% 
  rowwise() %>% tidy(model)

no.turnout.model <- state.county.offices.filter %>% filter(!is.na(ave.030)) %>% 
  group_by(state_abb) %>%
  do(model = lm(D_win_margin ~ lag.dmargin + White + age65 + offices.diff + ads.diff, .)) %>% 
  rowwise() %>% tidy(model)

offices.ads.test.model <- offices.ads.model %>% select(state_abb, r.squared, adj.r.squared)
no.turnout.test.model <- no.turnout.model %>% select(state_abb, r.squared, adj.r.squared) %>% rename(no.turnout.r.squared = r.squared, no.turnout.adj.r.squared = adj.r.squared)

my.data <- merge(offices.ads.test.model, no.turnout.test.model, by = "state_abb", all = TRUE) %>% mutate(r.diff = r.squared - no.turnout.r.squared, adj.r.diff = adj.r.squared - no.turnout.adj.r.squared)


#13 sig w/o ave.030, 13 sig w/ ave.030 + filter on ave.030 n/as
test.data <- offices.ads.model %>% filter(term == "turnout.pct", p.value < 0.05)
```

```{r}
# my.multi.model <- lmer(D_win_margin ~ unem.diff + ave.030 + (1 + turnout.pct + lag.dmargin + White + age65|state), data = state.county.data)
```